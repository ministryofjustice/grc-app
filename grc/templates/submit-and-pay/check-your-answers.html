{% extends 'base.html' %}
{% import "govuk-design-system-templates/_summary-list-item.html" as summary_list_item %}
{% import "govuk-design-system-templates/checkbox-single.html" as checkbox_single %}
{% import "govuk-design-system-templates/error-summary.html" as error_summary %}

{% block title %}Check your answers before sending your application{% endblock %}

{% block backLink %}
    <a href="{{ url_for('taskList.index') }}" class="govuk-back-link">Back</a>
{% endblock %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">

            {{ error_summary.renderFor(form) }}

            <h1 class="govuk-heading-l">
                Check your answers before sending your application
            </h1>

            <h2 class="govuk-heading-m">
                Confirmation
            </h2>

            <dl class="govuk-summary-list govuk-!-margin-bottom-9">
                {{ summary_list_item.render(
                    title='Have you ever been issued a Gender Recognition Certificate (or its equivalent) in another country?',
                    changeLinkHiddenText='if you have ever been issued a Gender Recognition Certificate (or its equivalent) in another country',
                    changeLinkUrl=url_for('startApplication.overseas_check'),
                    value=(session['application']['confirmation']['overseasCheck'])
                ) }}

                {% if session['application']['confirmation']['overseasCheck'] == 'Yes' %}
                    {{ summary_list_item.render(
                        title='Do you have official documentation that shows you have ever been issued a Gender Recognition Certificate (or its equivalent) in one of the allowed countries or territories?',
                        changeLinkHiddenText='if you have official documentation that shows you have ever been issued a Gender Recognition Certificate (or its equivalent) in one of the allowed countries or territories',
                        changeLinkUrl=url_for('startApplication.overseas_approved_check'),
                        value=(session['application']['confirmation']['overseasApprovedCheck'])
                    ) }}
                {% endif %}

                {{ summary_list_item.render(
                    title='Do you consent to the General Register Office contacting you about your application?',
                    changeLinkHiddenText='if you consent to the General Register Office contacting you about your application',
                    changeLinkUrl=url_for('startApplication.declaration'),
                    value=('Yes' if session['application']['confirmation']['declaration'] else 'No')
                ) }}
            </dl>

            <h2 class="govuk-heading-m">
                Your personal details
            </h2>

            <dl class="govuk-summary-list govuk-!-margin-bottom-9">
                {{ summary_list_item.render(
                    title='Name (as you would like it to appear on your Gender Recognition Certificate)',
                    changeLinkHiddenText='name (as you would like it to appear on your Gender Recognition Certificate)',
                    changeLinkUrl=url_for('personalDetails.index'),
                    value=(session['application']['personalDetails']['title'] + ' ' + session['application']['personalDetails']['first_name'] + ' ' + session['application']['personalDetails']['last_name'])
                ) }}

                {{ summary_list_item.render(
                    title='Affirmed gender',
                    changeLinkHiddenText='affirmed gender',
                    changeLinkUrl=url_for('personalDetails.affirmedGender'),
                    value=('Male' if session['application']['personalDetails']['affirmed_gender'] == 'MALE' else 'Female')
                ) }}

                {{ summary_list_item.render(
                    title='When you transitioned',
                    changeLinkHiddenText='when you transitioned',
                    changeLinkUrl=url_for('personalDetails.transitionDate'),
                    value=(strptime('{}-{}-1'.format(session['application']['personalDetails']['transition_date_year'],
                                 session['application']['personalDetails']['transition_date_month']),
                                 '%Y-%m-%d')
                                 .strftime('%B %Y')
                    )
                ) }}

                {{ summary_list_item.render(
                    title='Ever changed name',
                    changeLinkHiddenText='whether you have changed your name to reflect your gender',
                    changeLinkUrl=url_for('personalDetails.previousNamesCheck'),
                    value=(session['application']['personalDetails']['previousNamesCheck'])
                ) }}

                {% macro addressValue() %}
                    {{ session['application']['personalDetails']['address']['address_line_one'] }}<br>
                    {{ session['application']['personalDetails']['address']['address_line_two'] }}<br>
                    {{ session['application']['personalDetails']['address']['town'] }}<br>
                    {{ session['application']['personalDetails']['address']['postcode'] }}
                {% endmacro %}
                {{ summary_list_item.render(
                    title='Address',
                    changeLinkHiddenText='address',
                    changeLinkUrl=url_for('personalDetails.address'),
                    value=(addressValue())
                ) }}

                {% macro contactPreferencesValue() %}
                    <ul class="govuk-list">
                        {% if session['application']['personalDetails']['contactPreferences']['email'] != '' %}
                            <li>
                                Email: {{ session['application']['personalDetails']['contactPreferences']['email'] }}
                            </li>
                        {% endif %}
                        {% if session['application']['personalDetails']['contactPreferences']['phone'] != '' %}
                            <li>
                                Phone: {{ session['application']['personalDetails']['contactPreferences']['phone'] }}
                            </li>
                        {% endif %}
                        {% if session['application']['personalDetails']['contactPreferences']['post'] != '' %}
                            <li>
                                Post: {{ session['application']['personalDetails']['contactPreferences']['post'] }}
                            </li>
                        {% endif %}
                    </ul>
                {% endmacro %}
                {{ summary_list_item.render(
                    title='Contact preferences',
                    changeLinkHiddenText='contact preferences',
                    changeLinkUrl=url_for('personalDetails.contactPreferences'),
                    value=(contactPreferencesValue())
                ) }}

                {% macro unavailabilityValue() %}
                    {{ session['application']['personalDetails']['contactDates']['answer'] }}<br>
                    {% if session['application']['personalDetails']['contactDates']['answer'] == 'Yes' %}
                        {# Note: The following <span> should all be on one line, to allow the line breaks to work correctly #}
                        <span style="white-space: pre-line;">{{ session['application']['personalDetails']['contactDates']['dates'] }}</span>
                    {% endif %}
                {% endmacro %}
                {{ summary_list_item.render(
                    title='Unavailable over the next 6 months',
                    changeLinkHiddenText="whether there are any dates you don't want us to contact you by post over the next 6 months",
                    changeLinkUrl=url_for('personalDetails.contactDates'),
                    value=(unavailabilityValue())
                ) }}

                {{ summary_list_item.render(
                    title='Notify HMRC',
                    changeLinkHiddenText="whether you want us to notify HMRC after you receive a Gender Recognition Certificate",
                    changeLinkUrl=url_for('personalDetails.hmrc'),
                    value=(session['application']['personalDetails']['hmrc']['answer'])
                ) }}

                {% if session['application']['personalDetails']['hmrc']['answer'] == 'Yes' %}
                    {{ summary_list_item.render(
                        title='National insurance number',
                        changeLinkHiddenText="your National Insurance number",
                        changeLinkUrl=url_for('personalDetails.hmrc'),
                        value=(session['application']['personalDetails']['hmrc']['national_insurance_number'])
                    ) }}
                {% endif %}
            </dl>

            <h2 class="govuk-heading-m">
                Birth registration details
            </h2>

            <dl class="govuk-summary-list govuk-!-margin-bottom-9">
                {{ summary_list_item.render(
                    title='Birth name',
                    changeLinkHiddenText='birth name',
                    changeLinkUrl=url_for('birthRegistration.index'),
                    value=(session['application']['birthRegistration']['first_name'] + ' ' + session['application']['birthRegistration']['middle_names'] + ' ' + session['application']['birthRegistration']['last_name'])
                ) }}

                {{ summary_list_item.render(
                    title='Date of birth',
                    changeLinkHiddenText='date of birth',
                    changeLinkUrl=url_for('birthRegistration.dob'),
                    value=(
                        strptime('{}-{}-{}'.format(session['application']['birthRegistration']['dob']['year'],
                                 session['application']['birthRegistration']['dob']['month'],
                                 session['application']['birthRegistration']['dob']['day']),
                                 '%Y-%m-%d')
                                 .strftime('%d %B %Y')
                    )
                ) }}

                {{ summary_list_item.render(
                    title='Birth registered in UK',
                    changeLinkHiddenText='whether your birth was regstered in the UK',
                    changeLinkUrl=url_for('birthRegistration.ukCheck'),
                    value=(session['application']['birthRegistration']['ukCheck'])
                ) }}

                {% if session['application']['birthRegistration']['ukCheck'] == 'Yes' %}
                    {{ summary_list_item.render(
                        title='Town or city of birth',
                        changeLinkHiddenText='your town or city of birth',
                        changeLinkUrl=url_for('birthRegistration.placeOfBirth'),
                        value=(session['application']['birthRegistration']['place_of_birth'])
                    ) }}

                    {% macro mothersNameValue() %}
                        {{ session['application']['birthRegistration']['mothers_first_name'] }}
                        {{ session['application']['birthRegistration']['mothers_last_name'] }}<br>
                        (Maiden name: {{ session['application']['birthRegistration']['mothers_maiden_name'] }})
                    {% endmacro %}
                    {{ summary_list_item.render(
                        title="Mother's name",
                        changeLinkHiddenText="your mother's name",
                        changeLinkUrl=url_for('birthRegistration.mothersName'),
                        value=mothersNameValue()
                    ) }}

                    {{ summary_list_item.render(
                        title="Father's name listed",
                        changeLinkHiddenText="whether your father's name is listed on your birth or adoption certificate",
                        changeLinkUrl=url_for('birthRegistration.fathersNameCheck'),
                        value=(session['application']['birthRegistration']['fathersNameCheck'])
                    ) }}

                    {% if session['application']['birthRegistration']['fathersNameCheck'] == 'Yes' %}
                        {{ summary_list_item.render(
                            title="Father's name",
                            changeLinkHiddenText="your father's name",
                            changeLinkUrl=url_for('birthRegistration.fathersName'),
                            value=(session['application']['birthRegistration']['fathers_first_name'] + ' ' + session['application']['birthRegistration']['fathers_last_name'])
                        ) }}
                    {% endif %}

                    {{ summary_list_item.render(
                        title="Adopted",
                        changeLinkHiddenText="whether you were adopted",
                        changeLinkUrl=url_for('birthRegistration.adopted'),
                        value=(session['application']['birthRegistration']['adopted'])
                    ) }}

                    {% if session['application']['birthRegistration']['adopted'] == 'Yes' %}
                        {{ summary_list_item.render(
                            title="Adopted in UK",
                            changeLinkHiddenText="whether you were adopted in the UK",
                            changeLinkUrl=url_for('birthRegistration.adoptedUK'),
                            value=(get_radio_pretty_value('AdoptedUKForm', 'adopted_uk', session['application']['birthRegistration']['adopted_uk']))
                        ) }}
                    {% endif %}

                    {{ summary_list_item.render(
                        title="Forces registering service, British Consul or High Commission, or under
                               Merchant Shipping or Civil Aviation provisions",
                        changeLinkHiddenText="whether your birth was registered under the Forces registering service,
                                              British Consul or High Commission, or under Merchant Shipping or Civil Aviation provisions",
                        changeLinkUrl=url_for('birthRegistration.forces'),
                        value=(session['application']['birthRegistration']['forces'])
                    ) }}

                {% else %}
                    {{ summary_list_item.render(
                        title="Registered birth country",
                        changeLinkHiddenText="the country you were born in",
                        changeLinkUrl=url_for('birthRegistration.country'),
                        value=(session['application']['birthRegistration']['country'])
                    ) }}
                {% endif %}
            </dl>

            <h2 class="govuk-heading-m">
                Marriage or civil partnership details
            </h2>

            <dl class="govuk-summary-list govuk-!-margin-bottom-9">
                {{ summary_list_item.render(
                    title='Currently married or in a civil partnership',
                    changeLinkHiddenText='if you are currently married or in a civil partnership',
                    changeLinkUrl=url_for('partnershipDetails.index'),
                    value=(session['application']['partnershipDetails']['marriageCivilPartnership'])
                ) }}

                {% if session['application']['partnershipDetails']['marriageCivilPartnership'] == 'Neither' %}
                    {{ summary_list_item.render(
                        title='Spouse or partner has died',
                        changeLinkHiddenText='if your spouse or partner has died',
                        changeLinkUrl=url_for('partnershipDetails.partnerDied'),
                        value=(session['application']['partnershipDetails']['partnerDied'])
                    ) }}

                    {{ summary_list_item.render(
                        title='Marriage or civil partnership has ended',
                        changeLinkHiddenText='if your marriage or civil partnership has ended',
                        changeLinkUrl=url_for('partnershipDetails.endedCheck'),
                        value=(session['application']['partnershipDetails']['endedCheck'])
                    ) }}

                {% else %}
                    {{ summary_list_item.render(
                        title='Remain married',
                        changeLinkHiddenText='if you plan to remain married after receiving your Gender Recognition Certificate',
                        changeLinkUrl=url_for('partnershipDetails.stayTogether'),
                        value=(session['application']['partnershipDetails']['stayTogether'])
                    ) }}

                    {% if session['application']['partnershipDetails']['stayTogether'] == 'Yes' %}
                        {{ summary_list_item.render(
                            title='Can provide a declaration of consent from your spouse',
                            changeLinkHiddenText='if you can provide a declaration of consent from your spouse',
                            changeLinkUrl=url_for('partnershipDetails.partnerAgrees'),
                            value=(session['application']['partnershipDetails']['partnerAgrees'])
                        ) }}
                    {% endif %}

                    {% if session['application']['partnershipDetails']['stayTogether'] == 'No' or session['application']['partnershipDetails']['partnerAgrees'] == 'No' %}
                        {{ summary_list_item.render(
                            title='Interim GRC',
                            changeLinkHiddenText='if you understand that you will receive an Interim GRC',
                            changeLinkUrl=url_for('partnershipDetails.interimCheck'),
                            value=(session['application']['partnershipDetails']['interimCheck'])
                        ) }}
                    {% endif %}
                {% endif %}
            </dl>


            <h2 class="govuk-heading-m">
                Your uploaded documents
            </h2>

            {% macro uploadedDocumentsList(section) %}
                <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-0">
                    {% for item in session['application'][section]['files'] %}
                        <li>{{ item | replace(session['application']['reference_number'] + '__' + section + '__', '') }}</li>
                    {% endfor %}
                </ul>
            {% endmacro %}

            <dl class="govuk-summary-list govuk-!-margin-bottom-9">
                {% if application.confirmation.overseasCheck == 'No' %}
                    {{ summary_list_item.render(
                        title='Your medical reports',
                        changeLinkHiddenText='the documents you have uploaded for your medical reports',
                        changeLinkUrl=url_for('upload.medicalReports'),
                        value=(uploadedDocumentsList('medicalReports'))
                    ) }}

                    {{ summary_list_item.render(
                        title='Evidence of living in your gender',
                        changeLinkHiddenText='the documents you have uploaded as evidence of living in your gender',
                        changeLinkUrl=url_for('upload.genderEvidence'),
                        value=(uploadedDocumentsList('genderEvidence'))
                    ) }}

                    {% if application.personalDetails.previousNamesCheck is defined and application.personalDetails.previousNamesCheck == 'Yes' %}
                        {{ summary_list_item.render(
                            title='Name change documents',
                            changeLinkHiddenText='the documents you have uploaded as evidence of changing your name',
                            changeLinkUrl=url_for('upload.nameChange'),
                            value=(uploadedDocumentsList('nameChange'))
                        ) }}
                    {% endif %}

                {% elif application.confirmation.overseasCheck == 'Yes' and application.personalDetails.previousNamesCheck is defined and application.personalDetails.previousNamesCheck == 'Yes' %}
                    {{ summary_list_item.render(
                        title='Name change documents',
                        changeLinkHiddenText='the documents you have uploaded as evidence of changing your name',
                        changeLinkUrl=url_for('upload.nameChange'),
                        value=(uploadedDocumentsList('nameChange'))
                    ) }}
                {% endif %}

                {% if application.partnershipDetails.marriageCivilPartnership is defined and (application.partnershipDetails.marriageCivilPartnership == 'Married' or (application.partnershipDetails.marriageCivilPartnership == 'Neither' and (application.partnershipDetails.partnerDied == 'Yes' or application.partnershipDetails.endedCheck == 'Yes'))) %}
                    {{ summary_list_item.render(
                        title='Marriage documents',
                        changeLinkHiddenText='the documents you have uploaded as evidence of your marriage or civil partnership',
                        changeLinkUrl=url_for('upload.marriageDocuments'),
                        value=(uploadedDocumentsList('marriageDocuments'))
                    ) }}
                {% endif %}

                {% if application.confirmation.overseasApprovedCheck == 'Yes' %}
                    {{ summary_list_item.render(
                        title='Overseas certificate documents',
                        changeLinkHiddenText='the documents you have uploaded as evidence of your overseas certificate',
                        changeLinkUrl=url_for('upload.overseasCertificate'),
                        value=(uploadedDocumentsList('overseasCertificate'))
                    ) }}
                {% endif %}

                {{ summary_list_item.render(
                    title='Statutory declarations',
                    changeLinkHiddenText='the statutory declarations documents you have uploaded',
                    changeLinkUrl=url_for('upload.statutoryDeclarations'),
                    value=(uploadedDocumentsList('statutoryDeclarations'))
                ) }}
            </dl>

            <h2 class="govuk-heading-m">
                Payment details
            </h2>

            <dl class="govuk-summary-list govuk-!-margin-bottom-9">
                {{ summary_list_item.render(
                    title='Payment method',
                    changeLinkHiddenText='payment method',
                    changeLinkUrl=url_for('submitAndPay.index'),
                    value=(session['application']['submitAndPay']['method'])
                ) }}

                {% if session['application']['submitAndPay']['method'] == 'Help' %}
                    {{ summary_list_item.render(
                        title='Help type',
                        changeLinkHiddenText='the way your are applying for help with paying the fees',
                        changeLinkUrl=url_for('submitAndPay.helpType'),
                        value=(session['application']['submitAndPay']['helpType'])
                    ) }}

                    {% if session['application']['submitAndPay']['helpType'] == 'Using the online service' %}
                        {{ summary_list_item.render(
                            title='Help with Fees reference number',
                            changeLinkHiddenText='your Help with Fees reference number',
                            changeLinkUrl=url_for('submitAndPay.helpType'),
                            value=(session['application']['submitAndPay']['referenceNumber'])
                        ) }}
                    {% endif %}
                {% endif %}
            </dl>


            <h2 class="govuk-heading-m">
                Documents you'll need to post
            </h2>
            <p class="govuk-body govuk-!-margin-bottom-2">
                Based on your application the documents that will need to be posted are:
            </p>

            <ul class="govuk-list govuk-list--bullet govuk-!-margin-bottom-9">
                <li>
                    your original or a
                    <a href="https://www.gov.uk/certifying-a-document" rel="external" target="_blank" class="govuk-link">
                        certified copy (opens in new tab)
                    </a>
                    of your full birth or adoption certificate
                </li>

                {% if session['application']['submitAndPay']['helpType'] == 'Using the EX160 form' %}
                    <li>
                        an
                        <a href="https://www.gov.uk/government/publications/apply-for-help-with-court-and-tribunal-fees"
                           rel="external" target="_blank" class="govuk-link">
                            EX160 form (opens in new tab)
                        </a>
                    </li>
                {% endif %}
            </ul>


            <h2 class="govuk-heading-m">
                Now send your application
            </h2>

            <form method="POST" action="{{ url_for('submitAndPay.checkYourAnswers') }}">
                {{ form.csrf_token }}

                <div class="checkboxes-long-text">
                    {{ checkbox_single.renderFor(
                        form,
                        fieldName='certify',
                        label='I certify that all information given in this application is correct
                                  and that I understand making a false application is an offence.',
                        checkboxOptions={
                            'questionClasses': 'govuk-fieldset__legend--m'
                        }
                    ) }}
                </div>

                <div class="govuk-button-group">
                    <button class="govuk-button" data-module="govuk-button">
                        {% if session['application']['submitAndPay']['method'] == 'Help' %}
                            Submit application
                        {% else %}
                            Submit application and pay online
                        {% endif %}
                    </button>
                </div>
            </form>

        </div>
    </div>
{% endblock %}
